# This workflow automatically syncs merged changes from master/main to next branch
name: ðŸ”„ Sync master to next

on:
  push:
    branches: [master, main]

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  TARGET_BRANCH: next
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create sync branch and cherry-pick commits
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_BRANCH="${{ github.ref_name }}"
          SYNC_BRANCH="sync-${{ github.run_id }}-to-${{ env.TARGET_BRANCH }}"

          # Fetch all branches
          git fetch --all

          # Ensure target branch exists
          if ! git ls-remote --exit-code origin "${{ env.TARGET_BRANCH }}" > /dev/null 2>&1; then
            echo "::error::Target branch '${{ env.TARGET_BRANCH }}' does not exist"
            exit 1
          fi

          # Create sync branch from target
          git checkout -b "$SYNC_BRANCH" "origin/${{ env.TARGET_BRANCH }}"

          # Get commits from the push (excluding merge commits)
          COMMITS=$(git log "origin/${{ env.TARGET_BRANCH }}..${BASE_BRANCH}" --no-merges --pretty=format:"%H")

          echo "Cherry-picking commits..."
          CONFLICTS=false
          for commit in $COMMITS; do
            echo "Cherry-picking: $commit"
            if ! git cherry-pick "$commit"; then
              echo "::warning::Cherry-pick conflict detected for $commit"
              git cherry-pick --abort
              CONFLICTS=true
              break
            fi
          done

          if [ "$CONFLICTS" = true ]; then
            # Reset to target branch if conflicts
            git checkout -B "$SYNC_BRANCH" "origin/${{ env.TARGET_BRANCH }}"
            echo "âš ï¸ Cherry-pick failed due to conflicts. Creating PR for manual resolution."
          fi

          # Push sync branch
          git push origin "$SYNC_BRANCH"

          # Build PR body
          PR_BODY="ðŸ¤– **Auto-sync from ${BASE_BRANCH}**
          This PR automatically syncs the latest changes from \`${BASE_BRANCH}\` to the \`${{ env.TARGET_BRANCH }}\` branch.

          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          if [ "$CONFLICTS" = true ]; then
            PR_BODY="$PR_BODY

          âš ï¸ **Merge Conflicts Detected**
          This PR requires manual resolution of merge conflicts."
          fi

          # Create PR
          gh pr create \
            --base "${{ env.TARGET_BRANCH }}" \
            --head "$SYNC_BRANCH" \
            --title "[Sync][${BASE_BRANCH} -> ${{ env.TARGET_BRANCH }}]: Auto-sync" \
            --body "$PR_BODY"
